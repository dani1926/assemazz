<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ass e Mazz ‚Äì Segnapunti</title>
  <style>
    :root {
      --bg:#0f1220;
      --panel:#171a2b;
      --muted:#aab1c6;
      --text:#e8ecf5;
      --acc:#4cc9f0;
      --ok:#34d399;
      --warn:#f59e0b;
      --bad:#ef4444;
      --gold:#ffd166;
    }
    * { box-sizing: border-box; }
    body {
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background:linear-gradient(180deg,#0d1020,#0a0d16);
      color:var(--text);
    }
    header {
      padding:18px 16px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid #212642;
      position:sticky;
      top:0;
      background:rgba(13,16,32,.9);
      backdrop-filter: blur(6px);
      z-index: 10;
    }
    h1 {
      font-size:18px;
      margin:0;
      letter-spacing:.3px;
    }
    .wrap {
      max-width: 1100px;
      margin: 18px auto;
      padding: 0 16px 48px;
      display:grid;
      grid-template-columns:1fr;
      gap:16px;
    }
    @media (min-width: 900px){
      .wrap{ grid-template-columns: 1.1fr .9fr; }
    }
    .card {
      background:var(--panel);
      border:1px solid #232843;
      border-radius:14px;
      padding:14px;
    }
    .card h2 {
      margin:6px 0 12px;
      font-size:16px;
    }
    .row {
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    input[type="text"], input[type="number"] {
      background:#0f1326;
      border:1px solid #2a3155;
      color:var(--text);
      padding:10px 12px;
      border-radius:10px;
      outline:none;
      width:100%;
    }
    input[type="number"] { max-width:120px; }
    input::placeholder { color:#7f88a6; }
    .btn {
      appearance:none;
      border:1px solid #2a3155;
      background:#111633;
      color:var(--text);
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
      transition:.15s transform, .15s background, .15s border;
    }
    .btn:hover { background:#151b3d; }
    .btn:active { transform: translateY(1px); }
    .btn.acc { border-color: #226b82; background: #0d2430; }
    .btn.ok { border-color:#1e7a57; background:#0e2a22; }
    .btn.warn { border-color:#7a5a1e; background:#2a230e; }
    .btn.bad { border-color:#7a2a2a; background:#2a0e0e; }
    .btn.ghost { background:transparent; border-color:transparent; color:var(--muted); }
    .players { display:flex; flex-direction:column; gap:8px; }
    .player { display:flex; gap:8px; align-items:center; }
    .player input { flex: 1 1 auto; }
    .pill {
      font-size:12px;
      color:#8ea3ff;
      background:#0c1733;
      border:1px solid #22356b;
      padding:4px 8px;
      border-radius:999px;
    }
    table { width:100%; border-collapse: collapse; }
    th, td {
      border-bottom:1px dashed #2a3155;
      padding:10px 6px;
      text-align:left;
    }
    th { font-weight:600; color:#c7cbe2; }
    .leader {
      background:linear-gradient(90deg, rgba(76,201,240,.08), transparent);
    }
    .champ {
      background:linear-gradient(90deg, rgba(255,209,102,.18), transparent);
      box-shadow: inset 0 0 0 1px rgba(255,209,102,.45);
    }
    .right { text-align:right; }
    .muted { color:var(--muted); font-size:12px; }
    .tight { margin:6px 0 0; }
    .grid {
      display:grid;
      gap:8px;
      grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
    }
    .tag { font-size:11px; color:#b7bed8; }
    .note {
      font-size:12px;
      color:#cbd5e1;
      background:#0f152d;
      border:1px dashed #2a3155;
      padding:8px;
      border-radius:8px;
    }
    footer {
      text-align:center;
      color:#93a3c9;
      font-size:12px;
      padding:18px;
    }
    .danger { color: #ffb4b4; }
    .success { color: #b4ffd6; }
    .empty {
      color:#93a3c9;
      font-style:italic;
      padding:6px 0 2px;
    }
    .small { font-size:12px; }

    /* --- Modal (vittoria / scelta modalit√†) --- */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.65);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 9999;
    }
    .modal {
      background: radial-gradient(1200px 600px at 50% -10%, rgba(255,209,102,.15), transparent), #0f1220;
      border:1px solid #3a3145;
      border-radius:18px;
      padding:22px;
      max-width:640px;
      width:92%;
      text-align:center;
    }
    .modal h3 {
      margin:0 0 6px;
      font-size:26px;
    }
    .modal p {
      margin:8px 0 16px;
      color:#dfe6ff;
    }
    .modal .winner-name {
      font-size:28px;
      color: var(--gold);
      font-weight:800;
      letter-spacing:.4px;
    }
    canvas#confetti {
      position: fixed;
      inset:0;
      pointer-events:none;
      z-index: 9998;
      display:none;
    }
  </style>
</head>
<body>
<header>
  <div class="row" style="gap:10px">
    <h1 id="title">Ass e Mazz ¬∑ Segnapunti</h1>
    <span class="pill" id="mode-pill" title="Modalit√† corrente"></span>
  </div>
  <div class="row">
    <button id="btn-mode" class="btn">Modalit√†</button>
    <button id="btn-export" class="btn">Esporta</button>
    <label class="btn" for="import-file">
      Importa
      <input id="import-file" type="file" accept="application/json" style="display:none;">
    </label>
    <button id="btn-reset" class="btn bad">Azzera</button>
  </div>
</header>

<div class="wrap">
  <!-- Giocatori -->
  <section class="card" id="players-card">
    <h2>Giocatori</h2>
    <div class="players" id="players"></div>
    <div class="row" style="margin-top:8px">
      <input id="new-player" type="text" placeholder="Aggiungi giocatore (es. Daniele)" />
      <button id="add-player" class="btn acc">Aggiungi</button>
    </div>
    <p class="muted tight" id="players-hint"></p>
  </section>

  <!-- Punteggi & Obiettivo -->
  <section class="card">
    <h2>Punteggi</h2>
    <div id="scoreboard"></div>
    <div class="row" style="margin-top:8px">
      <div class="row" style="gap:6px">
        <span class="tag">Obiettivo</span>
        <input id="target" type="number" placeholder="(opzionale)" min="1" />
        <button id="save-target" class="btn">Imposta</button>
        <button id="clear-target" class="btn ghost">Rimuovi</button>
      </div>
    </div>
    <p id="winner-banner" class="note" style="display:none"></p>
  </section>

  <!-- Nuovo turno -->
  <section class="card">
    <h2>Nuovo turno</h2>
    <div id="turn-form"></div>
    <div class="row" style="margin-top:8px">
      <input id="turn-note" type="text" placeholder="Nota del turno (opzionale)" />
      <button id="add-turn" class="btn ok">Aggiungi turno</button>
      <button id="undo-turn" class="btn warn">Annulla ultimo turno</button>
    </div>
    <p class="muted tight" id="turn-hint"></p>
  </section>

  <!-- Storico -->
  <section class="card">
    <h2>Storico turni</h2>
    <div id="history"></div>
  </section>
</div>

<!-- Modal vittoria + Confetti -->
<canvas id="confetti"></canvas>
<div id="win-backdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="win-title">
  <div class="modal">
    <h3 id="win-title">üéâ Vittoria!</h3>
    <p>
      <span class="winner-name" id="win-name"></span><br/>
      <span id="win-rule"></span> con <strong id="win-score"></strong> punti
    </p>
    <button id="win-ok" class="btn acc">OK</button>
  </div>
</div>

<!-- Modal scelta modalit√† -->
<div id="mode-backdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="mode-title">
  <div class="modal">
    <h3 id="mode-title">Scegli modalit√†</h3>
    <p class="muted" id="mode-desc"></p>
    <div class="row" style="justify-content:center; gap:10px; margin-top:14px">
      <button id="mode-assemazz" class="btn acc">Ass e Mazz (21)</button>
      <button id="mode-37" class="btn acc">3 e 7 (11)</button>
    </div>
    <div class="row" style="justify-content:center; margin-top:10px">
      <button id="mode-cancel" class="btn ghost">Annulla</button>
    </div>
  </div>
</div>

<footer>
  <span class="small">
    Salvataggio automatico su questo dispositivo. ¬∑ Shortcut: <code>Invio</code> aggiunge turno quando sei nell‚Äôultimo campo.
  </span>
</footer>

<script>
  /* ---------- Modello dati ---------- */
  const storageKey = "assemazz_v3";

  const MODES = {
    ASSEMAZZ: { id: "assemazz", name: "Ass e Mazz", limit: 21, winner: "MIN" }, // vince chi ha meno
    TRE7:     { id: "3e7",      name: "3 e 7",      limit: 11, winner: "MAX" }  // vince chi ha pi√π
  };

  const $ = (sel, root = document) => root.querySelector(sel);
  const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

  const state = load() || {
    mode: null,   // "assemazz" | "3e7"
    players: [],  // {id, name, score}
    rounds: [],   // {id, values: {playerId: points}, note, ts}
    target: null  // numeric or null
  };

  function currentMode(){
    return state.mode === MODES.TRE7.id ? MODES.TRE7 : MODES.ASSEMAZZ;
  }

  function TURN_LIMIT(){
    return currentMode().limit;
  }

  function save(){
    localStorage.setItem(storageKey, JSON.stringify(state));
  }

  function load(){
    try {
      return JSON.parse(localStorage.getItem(storageKey));
    } catch {
      return null;
    }
  }

  function uid(){
    return Math.random().toString(36).slice(2,9);
  }

  /* ---------- Rendering ---------- */

  function renderModeUI(){
    const m = currentMode();
    $('#title').textContent = `${m.name} ¬∑ Segnapunti`;
    $('#mode-pill').textContent = `Modalit√†: ${m.name}`;
    $('#players-hint').innerHTML = `üí° Limite per turno: <strong>¬±${m.limit}</strong> punti per giocatore. Trascina per riordinare (desktop).`;
    $('#turn-hint').innerHTML =
      `Inserisci i punti (ammessi negativi). <strong>Max ¬±${m.limit}</strong> per giocatore.
       Se lasci <strong>un solo giocatore vuoto</strong>, gli verranno assegnati automaticamente i punti mancanti per arrivare a ${m.limit}.`;
    $('#mode-desc').innerHTML =
      `Ass e Mazz: limite 21, vince chi ha <strong>meno</strong> punti. ¬∑ 3 e 7: limite 11, vince chi ha <strong>pi√π</strong> punti.`;
  }

  function renderPlayers(){
    const box = $('#players');

    if(state.players.length === 0){
      box.innerHTML = `<div class="empty">Nessun giocatore. Aggiungine uno qui sotto.</div>`;
      renderScoreboard();
      renderTurnForm();
      return;
    }

    box.innerHTML = "";
    state.players.forEach((p, idx) => {
      const row = document.createElement('div');
      row.className = 'player';
      row.draggable = true;
      row.dataset.id = p.id;

      row.innerHTML = `
        <input class="player-name" value="${escapeHtml(p.name)}" aria-label="Nome giocatore ${idx+1}">
        <button class="btn bad remove" title="Rimuovi">üóë</button>
      `;

      row.querySelector('.player-name').addEventListener('change', e => {
        p.name = e.target.value.trim() || `Giocatore ${idx+1}`;
        save();
        renderScoreboard();
        renderTurnForm();
        renderHistory();
      });

      row.querySelector('.remove').addEventListener('click', () => {
        if(!confirm(\`Rimuovere \${p.name}? Saranno eliminati anche i suoi punti nei turni.\`)) return;
        const i = state.players.findIndex(x => x.id === p.id);
        state.players.splice(i,1);
        state.rounds.forEach(r => delete r.values[p.id]);
        save();
        renderPlayers();
        renderScoreboard();
        renderTurnForm();
        renderHistory();
        checkWinner();
      });

      // drag reorder
      row.addEventListener('dragstart', e => e.dataTransfer.setData('text/plain', p.id));
      row.addEventListener('dragover', e => { e.preventDefault(); row.style.outline='1px dashed #4cc9f0'; });
      row.addEventListener('dragleave', () => { row.style.outline=''; });
      row.addEventListener('drop', e => {
        e.preventDefault();
        row.style.outline='';
        const draggedId = e.dataTransfer.getData('text/plain');
        const from = state.players.findIndex(pp => pp.id===draggedId);
        const to = state.players.findIndex(pp => pp.id===p.id);
        if(from>=0 && to>=0 && from!==to){
          const [moved] = state.players.splice(from,1);
          state.players.splice(to,0,moved);
          save();
          renderPlayers();
          renderScoreboard();
          renderTurnForm();
        }
      });

      box.appendChild(row);
    });
  }

  function isGameOver() {
    if (state.target == null) return false;
    return state.players.some(p => (p.score ?? 0) >= state.target);
  }

  function sortedPlayersDesc(){
    return [...state.players].sort((a,b) => (b.score ?? 0) - (a.score ?? 0));
  }

  function renderScoreboard(){
    const box = $('#scoreboard');

    if(state.players.length === 0) {
      box.innerHTML = `<div class="empty">Inizia aggiungendo i giocatori.</div>`;
      return;
    }

    const m = currentMode();
    const gameOver = isGameOver();

    const scores = state.players.map(p => p.score ?? 0);
    const min = Math.min(...scores);
    const max = Math.max(...scores);

    const rows = sortedPlayersDesc().map(p => {
      const score = p.score ?? 0;

      // Winner logic:
      // - Ass e Mazz: migliore = MIN
      // - 3 e 7: migliore = MAX
      const isBest =
        (m.winner === "MIN" && score === min) ||
        (m.winner === "MAX" && score === max);

      let rowClass = '';
      if (isBest) rowClass = gameOver ? 'champ' : 'leader';

      return `
        <tr class="${rowClass}">
          <td>${escapeHtml(p.name)}</td>
          <td class="right"><strong>${score}</strong></td>
        </tr>
      `;
    }).join('');

    box.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>Giocatore</th>
            <th class="right">Totale</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
      ${
        state.target
          ? `<p class="tight"><span class="pill">Obiettivo: ${state.target} punti</span></p>`
          : `<p class="tight muted">Nessun obiettivo impostato</p>`
      }
    `;
  }

  function renderTurnForm(){
    const box = $('#turn-form');

    if(state.players.length === 0){
      box.innerHTML = `<div class="empty">Aggiungi giocatori per inserire un turno.</div>`;
      return;
    }

    const lim = TURN_LIMIT();
    const inputs = state.players.map(p => `
      <div>
        <label class="tag">${escapeHtml(p.name)}</label>
        <input
          type="number"
          class="turn-input"
          data-id="${p.id}"
          placeholder="+/- punti"
          step="1"
          min="-${lim}"
          max="${lim}"
        />
      </div>
    `).join('');

    box.innerHTML = `<div class="grid">${inputs}</div>`;

    const all = $$('.turn-input', box);
    if(all.length){
      const last = all[all.length-1];
      last.addEventListener('keydown', e => {
        if(e.key === 'Enter') $('#add-turn').click();
      });
    }
  }

  function renderHistory(){
    const box = $('#history');
    if(state.rounds.length === 0){
      box.innerHTML = `<div class="empty">Ancora nessun turno registrato.</div>`;
      return;
    }

    const items = state.rounds.map((r, idx) => {
      const stamp = new Date(r.ts).toLocaleString();
      const rows = state.players.map(p => {
        const v = r.values[p.id];
        const signClass = v > 0 ? 'success' : (v < 0 ? 'danger' : '');
        return `<span class="${signClass}">${escapeHtml(p.name)}: ${v ?? 0}</span>`;
      }).join(' ¬∑ ');

      const noteHtml = r.note ? ` ¬∑ <em>${escapeHtml(r.note)}</em>` : '';

      return `
        <div class="note" style="margin-bottom:8px">
          <div><strong>Turno ${idx+1}</strong> ¬∑ <span class="muted">${stamp}</span>${noteHtml}</div>
          <div style="margin-top:6px">${rows}</div>
        </div>
      `;
    }).reverse().join('');

    box.innerHTML = items;
  }

  function bestPlayers(){
    const m = currentMode();
    const scores = state.players.map(p => p.score ?? 0);
    const min = Math.min(...scores);
    const max = Math.max(...scores);

    const bestScore = (m.winner === "MIN") ? min : max;
    const winners = state.players.filter(p => (p.score ?? 0) === bestScore);
    return { winners, bestScore };
  }

  function checkWinner(triggerModal = false){
    const banner = $('#winner-banner');

    if (!state.target) {
      banner.style.display = 'none';
      banner.textContent = '';
      return;
    }

    if (!isGameOver()) {
      banner.style.display = 'none';
      banner.textContent = '';
      return;
    }

    const { winners, bestScore } = bestPlayers();
    const top = winners[0];
    const m = currentMode();

    const ruleText = (m.winner === "MIN") ? "punteggio pi√π basso" : "punteggio pi√π alto";

    banner.style.display = 'block';
    banner.innerHTML = `üèÜ <strong>${escapeHtml(top.name)}</strong> vince con <strong>${bestScore}</strong> punti (${ruleText}).`;

    if (triggerModal) showWinModal(top, ruleText);
  }

  /* ---------- Azioni ---------- */

  function addPlayer(name){
    name = (name||'').trim();
    if(!name) return;

    if(state.players.some(p => p.name.toLowerCase() === name.toLowerCase())){
      alert('Nome gi√† presente.');
      return;
    }

    state.players.push({ id: uid(), name, score: 0 });
    save();
    renderPlayers();
    renderScoreboard();
    renderTurnForm();
  }

  function addTurn(){
    if(state.players.length===0) return;

    const lim = TURN_LIMIT();

    const inputs = $$('.turn-input');
    const values = {};
    let anyFilled = false;

    let sumFilled = 0;
    let filledCount = 0;
    const emptyInputs = [];

    // Primo pass: leggo i campi, ma NON tratto i vuoti come 0
    for (const inp of inputs) {
      const raw = inp.value.trim();
      const playerId = inp.dataset.id;

      if (raw === '') { emptyInputs.push(inp); continue; }

      const val = Number(raw);
      if (isNaN(val)) continue;

      // Validazione: ¬±lim
      if (Math.abs(val) > lim) {
        alert(`Limite per turno: ¬±${lim}. Valore non valido per "${getPlayerNameById(playerId)}" (${val}).`);
        inp.focus();
        return;
      }

      values[playerId] = val;
      if (val !== 0) anyFilled = true;
      sumFilled += val;
      filledCount++;
    }

    // Auto-calcolo punti mancanti:
    // - esattamente un giocatore vuoto
    // - nessun valore negativo
    // - somma <= lim
    if (emptyInputs.length === 1 && filledCount > 0) {
      const hasNegative = Object.values(values).some(v => v < 0);
      if (!hasNegative) {
        if (sumFilled > lim) {
          alert(`Somma dei punti (${sumFilled}) superiore al limite di ${lim}. Controlla i valori inseriti.`);
          return;
        }
        const leftover = lim - sumFilled;
        const autoInput = emptyInputs[0];
        const autoId = autoInput.dataset.id;

        values[autoId] = leftover;
        if (leftover !== 0) anyFilled = true;
      }
    }

    if (!anyFilled) {
      if (!confirm('Tutti zero. Aggiungere comunque il turno?')) return;
    }

    const roundValues = {};
    state.players.forEach(p => {
      const v = values[p.id] ?? 0;
      roundValues[p.id] = v;
      p.score = (p.score ?? 0) + v;
    });

    state.rounds.push({
      id: uid(),
      values: roundValues,
      note: $('#turn-note').value.trim() || null,
      ts: Date.now()
    });

    inputs.forEach(i => i.value='');
    $('#turn-note').value='';

    save();
    renderScoreboard();
    renderHistory();

    const beforeHadWinner = $('#winner-banner').style.display === 'block';
    checkWinner(!beforeHadWinner);
  }

  function undoTurn(){
    if(state.rounds.length===0) return;

    const last = state.rounds.pop();
    Object.entries(last.values).forEach(([pid, val]) => {
      const p = state.players.find(pp => pp.id === pid);
      if(p) p.score = (p.score ?? 0) - (val ?? 0);
    });

    save();
    renderScoreboard();
    renderHistory();
    checkWinner();
  }

  function setTarget(){
    const raw = $('#target').value.trim();
    if(raw===''){
      state.target = null;
      save();
      renderScoreboard();
      checkWinner();
      return;
    }

    const n = Number(raw);
    if(!Number.isFinite(n) || n<=0) {
      alert('Inserisci un numero valido > 0.');
      return;
    }

    state.target = Math.floor(n);
    save();
    renderScoreboard();
    checkWinner();
  }

  function clearTarget(){
    state.target = null;
    $('#target').value = '';
    save();
    renderScoreboard();
    checkWinner();
  }

  function exportGame(){
    if (state.players.length === 0) {
      alert('Nessun giocatore da esportare.');
      return;
    }

    const m = currentMode();
    const scores = state.players.map(p => ({ name: p.name, score: p.score ?? 0 }));
    const { winners, bestScore } = bestPlayers();
    const ruleText = (m.winner === "MIN") ? "punteggio pi√π basso" : "punteggio pi√π alto";

    const lines = [];
    lines.push(`${m.name} ‚Äì Risultati`);
    lines.push('');
    lines.push(`Data: ${new Date().toLocaleString()}`);
    lines.push(`Limite per turno: ${m.limit}`);
    if (state.target != null) lines.push(`Punteggio obiettivo: ${state.target}`);
    lines.push('');

    // (opzionale) anche nel testo esportato: ordinati decrescente
    scores.sort((a,b)=>b.score-a.score).forEach(p => {
      const isWinner = p.score === bestScore;
      const label = isWinner ? `  <-- VINCITORE (${ruleText})` : '';
      lines.push(`${p.name}: ${p.score} punti${label}`);
    });

    if (winners.length > 1) {
      const names = winners.map(w => w.name).join(', ');
      lines.push('');
      lines.push(`Pareggio tra: ${names}`);
    }

    const summary = lines.join('\n');

    const exportData = {
      ...state,
      summary,
      version: 3,
      exportedAt: new Date().toISOString()
    };

    const blob = new Blob([JSON.stringify(exportData, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    const dt = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
    a.href = URL.createObjectURL(blob);
    a.download = `segnapunti-${m.id}-${dt}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  function importGame(file){
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const data = JSON.parse(reader.result);
        if(!data || !Array.isArray(data.players) || !Array.isArray(data.rounds)) throw new Error();

        // mode (fallback: assemazz)
        state.mode = (data.mode === MODES.TRE7.id || data.mode === MODES.ASSEMAZZ.id) ? data.mode : MODES.ASSEMAZZ.id;

        state.players = data.players.map(p => ({
          id: p.id || uid(),
          name: String(p.name || 'Giocatore'),
          score: Number(p.score || 0)
        }));

        state.rounds = data.rounds.map(r => ({
          id: r.id || uid(),
          values: r.values || {},
          note: r.note || null,
          ts: r.ts || Date.now()
        }));

        state.target = (data.target == null ? null : Number(data.target));

        save();
        renderModeUI();
        renderPlayers();
        renderScoreboard();
        renderTurnForm();
        renderHistory();
        checkWinner();
        alert('Partita importata con successo.');
      } catch {
        alert('File non valido.');
      }
    };
    reader.readAsText(file);
  }

  function resetAll(){
    if(!confirm('Azzera tutto? Questa azione non √® reversibile.')) return;
    state.players = [];
    state.rounds = [];
    state.target = null;
    // NON resetto mode: resta quella scelta
    save();
    renderPlayers();
    renderScoreboard();
    renderTurnForm();
    renderHistory();
    checkWinner();
  }

  /* ---------- Modal vittoria + confetti ---------- */

  const winBackdrop = $('#win-backdrop');
  const confettiCanvas = $('#confetti');
  const ctx = confettiCanvas.getContext('2d');

  function showWinModal(top, ruleText){
    if(!state.target) return;
    $('#win-name').textContent = top.name;
    $('#win-score').textContent = top.score;
    $('#win-rule').textContent = `ha vinto (${ruleText})`;
    winBackdrop.style.display = 'flex';
    startConfetti(2500);
    try { navigator.vibrate && navigator.vibrate([60,30,60]); } catch {}
    setTimeout(() => $('#win-ok').focus(), 50);
  }

  $('#win-ok').addEventListener('click', () => {
    winBackdrop.style.display='none';
    stopConfetti();
  });

  let confettiId = null;

  function startConfetti(ms=2000){
    resizeCanvas();
    confettiCanvas.style.display = 'block';

    const parts = Array.from({length: 160}, () => ({
      x: Math.random()*confettiCanvas.width,
      y: -Math.random()*confettiCanvas.height,
      r: Math.random()*6+3,
      vx: (Math.random()-0.5)*2,
      vy: Math.random()*2+2,
      a: Math.random()*Math.PI,
      va: Math.random()*0.2+0.05
    }));

    function frame(){
      ctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
      parts.forEach(p=>{
        p.x += p.vx;
        p.y += p.vy;
        p.a += p.va;
        if(p.y > confettiCanvas.height+10) {
          p.y = -10;
          p.x = Math.random()*confettiCanvas.width;
        }
        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.a);
        ctx.fillStyle = `hsl(${(p.x/confettiCanvas.width)*360}, 90%, 60%)`;
        ctx.fillRect(-p.r, -p.r/2, p.r*2, p.r);
        ctx.restore();
      });
      confettiId = requestAnimationFrame(frame);
    }

    frame();
    setTimeout(stopConfetti, ms);
  }

  function stopConfetti(){
    if(confettiId){
      cancelAnimationFrame(confettiId);
      confettiId=null;
    }
    confettiCanvas.style.display = 'none';
  }

  function resizeCanvas(){
    confettiCanvas.width = window.innerWidth;
    confettiCanvas.height = window.innerHeight;
  }

  window.addEventListener('resize', resizeCanvas);

  /* ---------- Modal scelta modalit√† ---------- */

  const modeBackdrop = $('#mode-backdrop');

  function openModeModal(force = false){
    if(!force && modeBackdrop.style.display === 'flex') return;
    modeBackdrop.style.display = 'flex';
    setTimeout(() => $('#mode-assemazz').focus(), 30);
  }

  function closeModeModal(){
    modeBackdrop.style.display = 'none';
  }

  function setMode(modeId){
    const isSame = state.mode === modeId;
    if(isSame) { closeModeModal(); return; }

    if(state.rounds.length > 0 || state.players.some(p => (p.score ?? 0) !== 0)){
      const ok = confirm('Cambiare modalit√† resetta punteggi e turni (regole diverse). Vuoi continuare?');
      if(!ok) return;
      state.players.forEach(p => p.score = 0);
      state.rounds = [];
      state.target = null;
      $('#target').value = '';
      $('#turn-note').value = '';
    }

    state.mode = modeId;
    save();
    renderModeUI();
    renderScoreboard();
    renderTurnForm();
    renderHistory();
    checkWinner();
    closeModeModal();
  }

  $('#btn-mode').addEventListener('click', () => openModeModal(false));
  $('#mode-assemazz').addEventListener('click', () => setMode(MODES.ASSEMAZZ.id));
  $('#mode-37').addEventListener('click', () => setMode(MODES.TRE7.id));
  $('#mode-cancel').addEventListener('click', closeModeModal);

  /* ---------- Utils ---------- */

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => (
      {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]
    ));
  }

  function getPlayerNameById(id){
    const p = state.players.find(x=>x.id===id);
    return p ? p.name : 'Giocatore';
  }

  /* ---------- Event binding ---------- */

  $('#add-player').addEventListener('click', () => {
    addPlayer($('#new-player').value);
    $('#new-player').value='';
    $('#new-player').focus();
  });

  $('#new-player').addEventListener('keydown', e => {
    if(e.key==='Enter') $('#add-player').click();
  });

  $('#add-turn').addEventListener('click', addTurn);
  $('#undo-turn').addEventListener('click', undoTurn);
  $('#save-target').addEventListener('click', setTarget);
  $('#clear-target').addEventListener('click', clearTarget);
  $('#btn-export').addEventListener('click', exportGame);

  $('#import-file').addEventListener('change', e => {
    if(e.target.files && e.target.files[0]) importGame(e.target.files[0]);
    e.target.value = '';
  });

  $('#btn-reset').addEventListener('click', resetAll);

  /* ---------- Init ---------- */

  function init(){
    // normalizzo score
    state.players.forEach(p => { if(typeof p.score!=='number') p.score=0; });

    // se non c'√® mode, chiedo scelta iniziale
    if(state.mode !== MODES.ASSEMAZZ.id && state.mode !== MODES.TRE7.id){
      state.mode = MODES.ASSEMAZZ.id; // default, ma mostro comunque la scelta
      save();
      renderModeUI();
      renderPlayers();
      renderScoreboard();
      renderTurnForm();
      renderHistory();
      checkWinner();
      if(state.target != null) $('#target').value = state.target;
      openModeModal(true);
      return;
    }

    renderModeUI();
    renderPlayers();
    renderScoreboard();
    renderTurnForm();
    renderHistory();
    checkWinner();
    if(state.target != null) $('#target').value = state.target;
  }

  init();
</script>
</body>
</html>
