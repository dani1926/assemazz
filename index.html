<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Segnapunti ‚Äì Ass e Mazz / 3 e 7</title>
  <style>
    :root {
      --bg:#0f1220;
      --panel:#171a2b;
      --muted:#aab1c6;
      --text:#e8ecf5;
      --acc:#4cc9f0;
      --ok:#34d399;
      --warn:#f59e0b;
      --bad:#ef4444;
      --gold:#ffd166;
    }
    * { box-sizing: border-box; }
    body {
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
      background:linear-gradient(180deg,#0d1020,#0a0d16);
      color:var(--text);
    }
    header {
      padding:18px 16px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid #212642;
      position:sticky;
      top:0;
      background:rgba(13,16,32,.9);
      backdrop-filter: blur(6px);
      z-index: 10;
    }
    h1 { font-size:18px; margin:0; letter-spacing:.3px; }
    .wrap {
      max-width: 1100px;
      margin: 18px auto;
      padding: 0 16px 48px;
      display:grid;
      grid-template-columns:1fr;
      gap:16px;
    }
    @media (min-width: 900px){
      .wrap{ grid-template-columns: 1.1fr .9fr; }
    }
    .card {
      background:var(--panel);
      border:1px solid #232843;
      border-radius:14px;
      padding:14px;
    }
    .card h2 { margin:6px 0 12px; font-size:16px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    input[type="text"], input[type="number"], select {
      background:#0f1326;
      border:1px solid #2a3155;
      color:var(--text);
      padding:10px 12px;
      border-radius:10px;
      outline:none;
      width:100%;
    }
    input[type="number"] { max-width:120px; }
    select { width:auto; }
    input::placeholder { color:#7f88a6; }
    .btn {
      appearance:none;
      border:1px solid #2a3155;
      background:#111633;
      color:var(--text);
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
      transition:.15s transform, .15s background, .15s border;
    }
    .btn:hover { background:#151b3d; }
    .btn:active { transform: translateY(1px); }
    .btn.acc { border-color: #226b82; background: #0d2430; }
    .btn.ok { border-color:#1e7a57; background:#0e2a22; }
    .btn.warn { border-color:#7a5a1e; background:#2a230e; }
    .btn.bad { border-color:#7a2a2a; background:#2a0e0e; }
    .btn.ghost { background:transparent; border-color:transparent; color:var(--muted); }

    .players { display:flex; flex-direction:column; gap:8px; }
    .player { display:flex; gap:8px; align-items:center; }
    .player input { flex: 1 1 auto; }

    table { width:100%; border-collapse: collapse; }
    th, td {
      border-bottom:1px dashed #2a3155;
      padding:10px 6px;
      text-align:left;
    }
    th { font-weight:600; color:#c7cbe2; }
    .right { text-align:right; }
    .muted { color:var(--muted); font-size:12px; }
    .tight { margin:6px 0 0; }
    .grid {
      display:grid;
      gap:8px;
      grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
    }
    .tag { font-size:11px; color:#b7bed8; }
    .note {
      font-size:12px;
      color:#cbd5e1;
      background:#0f152d;
      border:1px dashed #2a3155;
      padding:8px;
      border-radius:8px;
    }
    footer { text-align:center; color:#93a3c9; font-size:12px; padding:18px; }
    .danger { color: #ffb4b4; }
    .success { color: #b4ffd6; }
    .empty { color:#93a3c9; font-style:italic; padding:6px 0 2px; }
    .pill {
      font-size:12px;
      color:#8ea3ff;
      background:#0c1733;
      border:1px solid #22356b;
      padding:4px 8px;
      border-radius:999px;
      white-space: nowrap;
    }
    .leader {
      background:linear-gradient(90deg, rgba(76,201,240,.08), transparent);
    }
    .champ {
      background:linear-gradient(90deg, rgba(255,209,102,.18), transparent);
      box-shadow: inset 0 0 0 1px rgba(255,209,102,.45);
    }
  </style>
</head>
<body>
<header>
  <div class="row" style="gap:10px">
    <h1 id="app-title">Segnapunti</h1>
    <span class="pill" id="mode-pill"></span>
  </div>
  <div class="row">
    <select id="mode-select" title="Modalit√†">
      <option value="assemazz">Ass e Mazz</option>
      <option value="3e7">3 e 7</option>
    </select>
    <button id="btn-export" class="btn">Esporta</button>
    <label class="btn" for="import-file">
      Importa
      <input id="import-file" type="file" accept="application/json" style="display:none;">
    </label>
    <button id="btn-reset" class="btn bad">Azzera</button>
  </div>
</header>

<div class="wrap">
  <section class="card">
    <h2>Giocatori</h2>
    <div class="players" id="players"></div>
    <div class="row" style="margin-top:8px">
      <input id="new-player" type="text" placeholder="Aggiungi giocatore (es. Daniele)" />
      <button id="add-player" class="btn acc">Aggiungi</button>
    </div>
    <p class="muted tight" id="hint-players"></p>
  </section>

  <section class="card">
    <h2>Punteggi</h2>
    <div id="scoreboard"></div>
    <div class="row" style="margin-top:8px">
      <div class="row" style="gap:6px">
        <span class="tag">Obiettivo</span>
        <input id="target" type="number" placeholder="(opzionale)" min="1" />
        <button id="save-target" class="btn">Imposta</button>
        <button id="clear-target" class="btn ghost">Rimuovi</button>
      </div>
    </div>
    <p id="winner-banner" class="note" style="display:none"></p>
  </section>

  <section class="card">
    <h2>Nuovo turno</h2>
    <div id="turn-form"></div>
    <div class="row" style="margin-top:8px">
      <input id="turn-note" type="text" placeholder="Nota del turno (opzionale)" />
      <button id="add-turn" class="btn ok">Aggiungi turno</button>
      <button id="undo-turn" class="btn warn">Annulla ultimo turno</button>
    </div>
    <p class="muted tight" id="hint-turn"></p>
  </section>

  <section class="card">
    <h2>Storico turni</h2>
    <div id="history"></div>
  </section>
</div>

<footer>
  <span class="small">
    Salvataggio automatico su questo dispositivo. ¬∑ Shortcut: <code>Invio</code> aggiunge turno quando sei nell‚Äôultimo campo.
  </span>
</footer>

<script>
  const storageKey = "assemazz_v4";

  const MODES = {
    assemazz: { id:"assemazz", name:"Ass e Mazz", limit:21, winner:"MIN" },
    "3e7":    { id:"3e7",      name:"3 e 7",      limit:11, winner:"MAX" }
  };

  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const uid = () => Math.random().toString(36).slice(2,9);

  function load(){
    try { return JSON.parse(localStorage.getItem(storageKey)); }
    catch { return null; }
  }
  function save(){ localStorage.setItem(storageKey, JSON.stringify(state)); }

  const state = load() || {
    mode: "assemazz",
    players: [],
    rounds: [],
    target: null
  };

  function mode(){ return MODES[state.mode] || MODES.assemazz; }
  function limit(){ return mode().limit; }
  function scoreOf(p){ return (typeof p.score === "number") ? p.score : 0; }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => (
      {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]
    ));
  }

  function renderModeUI(){
    const m = mode();
    $("#app-title").textContent = `${m.name} ¬∑ Segnapunti`;
    $("#mode-pill").textContent = `Limite turno: ¬±${m.limit} ¬∑ Vince: ${m.winner==="MIN" ? "punteggio pi√π basso" : "punteggio pi√π alto"}`;
    $("#hint-players").innerHTML = `üí° Limite per turno: <strong>¬±${m.limit}</strong> punti per giocatore. Trascina per riordinare (desktop).`;
    $("#hint-turn").innerHTML =
      `Inserisci i punti (ammessi negativi). <strong>Max ¬±${m.limit}</strong> per giocatore.
       Se lasci <strong>un solo giocatore vuoto</strong>, gli verranno assegnati automaticamente i punti mancanti per arrivare a ${m.limit}.`;
    $("#mode-select").value = m.id;
  }

  function isGameOver(){
    if (state.target == null) return false;
    return state.players.some(p => scoreOf(p) >= state.target);
  }

  function bestPlayers(){
    const m = mode();
    if (state.players.length === 0) return { winners: [], bestScore: 0 };

    const scores = state.players.map(p => scoreOf(p));
    const min = Math.min.apply(null, scores);
    const max = Math.max.apply(null, scores);
    const bestScore = (m.winner === "MIN") ? min : max;
    const winners = state.players.filter(p => scoreOf(p) === bestScore);
    return { winners, bestScore };
  }

  function renderPlayers(){
    const box = $("#players");
    if (state.players.length === 0){
      box.innerHTML = `<div class="empty">Nessun giocatore. Aggiungine uno qui sotto.</div>`;
      renderScoreboard();
      renderTurnForm();
      return;
    }

    box.innerHTML = "";
    state.players.forEach((p, idx) => {
      const row = document.createElement("div");
      row.className = "player";
      row.draggable = true;
      row.dataset.id = p.id;

      row.innerHTML = `
        <input class="player-name" value="${escapeHtml(p.name)}" aria-label="Nome giocatore ${idx+1}">
        <button class="btn bad remove" title="Rimuovi">üóë</button>
      `;

      row.querySelector(".player-name").addEventListener("change", e => {
        p.name = (e.target.value.trim() || `Giocatore ${idx+1}`);
        save();
        renderScoreboard();
        renderTurnForm();
        renderHistory();
        checkWinner();
      });

      row.querySelector(".remove").addEventListener("click", () => {
        if(!confirm(`Rimuovere ${p.name}? Saranno eliminati anche i suoi punti nei turni.`)) return;
        state.players = state.players.filter(x => x.id !== p.id);
        state.rounds.forEach(r => { delete r.values[p.id]; });
        save();
        renderPlayers();
        renderScoreboard();
        renderTurnForm();
        renderHistory();
        checkWinner();
      });

      row.addEventListener("dragstart", e => e.dataTransfer.setData("text/plain", p.id));
      row.addEventListener("dragover", e => { e.preventDefault(); row.style.outline="1px dashed #4cc9f0"; });
      row.addEventListener("dragleave", () => { row.style.outline=""; });
      row.addEventListener("drop", e => {
        e.preventDefault();
        row.style.outline="";
        const draggedId = e.dataTransfer.getData("text/plain");
        const from = state.players.findIndex(pp => pp.id === draggedId);
        const to = state.players.findIndex(pp => pp.id === p.id);
        if(from >= 0 && to >= 0 && from !== to){
          const moved = state.players.splice(from,1)[0];
          state.players.splice(to,0,moved);
          save();
          renderPlayers();
          renderScoreboard();
          renderTurnForm();
        }
      });

      box.appendChild(row);
    });
  }

  function renderScoreboard(){
    const box = $("#scoreboard");
    if(state.players.length === 0){
      box.innerHTML = `<div class="empty">Inizia aggiungendo i giocatori.</div>`;
      return;
    }

    // ordinata decrescente SEMPRE
    const sorted = [...state.players].sort((a,b) => scoreOf(b) - scoreOf(a));

    const { bestScore } = bestPlayers();
    const gameOver = isGameOver();

    const rows = sorted.map(p => {
      const s = scoreOf(p);
      const isBest = (s === bestScore);
      const rowClass = isBest ? (gameOver ? "champ" : "leader") : "";
      return `
        <tr class="${rowClass}">
          <td>${escapeHtml(p.name)}</td>
          <td class="right"><strong>${s}</strong></td>
        </tr>
      `;
    }).join("");

    box.innerHTML = `
      <table>
        <thead>
          <tr><th>Giocatore</th><th class="right">Totale</th></tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
      ${
        state.target != null
          ? `<p class="tight"><span class="pill">Obiettivo: ${state.target} punti</span></p>`
          : `<p class="tight muted">Nessun obiettivo impostato</p>`
      }
    `;
  }

  function renderTurnForm(){
    const box = $("#turn-form");
    if(state.players.length === 0){
      box.innerHTML = `<div class="empty">Aggiungi giocatori per inserire un turno.</div>`;
      return;
    }

    const lim = limit();
    box.innerHTML = `
      <div class="grid">
        ${state.players.map(p => `
          <div>
            <label class="tag">${escapeHtml(p.name)}</label>
            <input type="number" class="turn-input" data-id="${p.id}"
              placeholder="+/- punti" step="1" min="-${lim}" max="${lim}">
          </div>
        `).join("")}
      </div>
    `;

    const all = $$(".turn-input", box);
    if(all.length){
      all[all.length-1].addEventListener("keydown", e => {
        if(e.key === "Enter") $("#add-turn").click();
      });
    }
  }

  function renderHistory(){
    const box = $("#history");
    if(state.rounds.length === 0){
      box.innerHTML = `<div class="empty">Ancora nessun turno registrato.</div>`;
      return;
    }

    const items = state.rounds.map((r, idx) => {
      const stamp = new Date(r.ts).toLocaleString();
      const rows = state.players.map(p => {
        const v = (r.values && typeof r.values[p.id] === "number") ? r.values[p.id] : 0;
        const cls = v > 0 ? "success" : (v < 0 ? "danger" : "");
        return `<span class="${cls}">${escapeHtml(p.name)}: ${v}</span>`;
      }).join(" ¬∑ ");

      const note = r.note ? ` ¬∑ <em>${escapeHtml(r.note)}</em>` : "";

      return `
        <div class="note" style="margin-bottom:8px">
          <div><strong>Turno ${idx+1}</strong> ¬∑ <span class="muted">${stamp}</span>${note}</div>
          <div style="margin-top:6px">${rows}</div>
        </div>
      `;
    }).reverse().join("");

    box.innerHTML = items;
  }

  function checkWinner(){
    const banner = $("#winner-banner");

    if(state.target == null){
      banner.style.display = "none";
      banner.textContent = "";
      return;
    }

    if(!isGameOver()){
      banner.style.display = "none";
      banner.textContent = "";
      return;
    }

    const m = mode();
    const { winners, bestScore } = bestPlayers();
    const ruleText = (m.winner === "MIN") ? "punteggio pi√π basso" : "punteggio pi√π alto";

    if(!winners.length){
      banner.style.display = "none";
      banner.textContent = "";
      return;
    }

    banner.style.display = "block";
    banner.innerHTML = `üèÜ <strong>${escapeHtml(winners[0].name)}</strong> vince con <strong>${bestScore}</strong> punti (${ruleText}).`;
  }

  function addPlayer(name){
    name = (name || "").trim();
    if(!name) return;

    if(state.players.some(p => String(p.name).toLowerCase() === name.toLowerCase())){
      alert("Nome gi√† presente.");
      return;
    }

    state.players.push({ id: uid(), name: name, score: 0 });
    save();
    renderPlayers();
    renderScoreboard();
    renderTurnForm();
    checkWinner();
  }

  function addTurn(){
    if(state.players.length === 0) return;

    const lim = limit();
    const inputs = $$(".turn-input");
    const values = {};
    let anyFilled = false;

    let sumFilled = 0;
    let filledCount = 0;
    const emptyInputs = [];

    for(const inp of inputs){
      const raw = inp.value.trim();
      const pid = inp.dataset.id;

      if(raw === ""){
        emptyInputs.push(inp);
        continue;
      }

      const val = Number(raw);
      if(!Number.isFinite(val)) continue;

      if(Math.abs(val) > lim){
        alert(`Limite per turno: ¬±${lim}. Valore non valido (${val}).`);
        inp.focus();
        return;
      }

      values[pid] = val;
      if(val !== 0) anyFilled = true;
      sumFilled += val;
      filledCount++;
    }

    // auto-mancanti (stessa logica tua) ma con limite dinamico
    if(emptyInputs.length === 1 && filledCount > 0){
      const hasNegative = Object.values(values).some(v => v < 0);
      if(!hasNegative){
        if(sumFilled > lim){
          alert(`Somma dei punti (${sumFilled}) superiore al limite di ${lim}.`);
          return;
        }
        const leftover = lim - sumFilled;
        const autoId = emptyInputs[0].dataset.id;
        values[autoId] = leftover;
        if(leftover !== 0) anyFilled = true;
      }
    }

    if(!anyFilled){
      if(!confirm("Tutti zero. Aggiungere comunque il turno?")) return;
    }

    const roundValues = {};
    state.players.forEach(p => {
      const v = (typeof values[p.id] === "number") ? values[p.id] : 0;
      roundValues[p.id] = v;
      p.score = scoreOf(p) + v;
    });

    state.rounds.push({
      id: uid(),
      values: roundValues,
      note: ($("#turn-note").value.trim() || null),
      ts: Date.now()
    });

    inputs.forEach(i => i.value = "");
    $("#turn-note").value = "";

    save();
    renderScoreboard();
    renderHistory();
    checkWinner();
  }

  function undoTurn(){
    if(state.rounds.length === 0) return;

    const last = state.rounds.pop();
    for(const [pid, val] of Object.entries(last.values || {})){
      const p = state.players.find(pp => pp.id === pid);
      if(p) p.score = scoreOf(p) - (Number(val) || 0);
    }

    save();
    renderScoreboard();
    renderHistory();
    checkWinner();
  }

  function setTarget(){
    const raw = $("#target").value.trim();
    if(raw === ""){
      state.target = null;
      save();
      renderScoreboard();
      checkWinner();
      return;
    }

    const n = Number(raw);
    if(!Number.isFinite(n) || n <= 0){
      alert("Inserisci un numero valido > 0.");
      return;
    }

    state.target = Math.floor(n);
    save();
    renderScoreboard();
    checkWinner();
  }

  function clearTarget(){
    state.target = null;
    $("#target").value = "";
    save();
    renderScoreboard();
    checkWinner();
  }

  function exportGame(){
    if(state.players.length === 0){
      alert("Nessun giocatore da esportare.");
      return;
    }

    const m = mode();
    const { bestScore } = bestPlayers();
    const ruleText = (m.winner === "MIN") ? "punteggio pi√π basso" : "punteggio pi√π alto";

    const lines = [];
    lines.push(`${m.name} ‚Äì Risultati`);
    lines.push("");
    lines.push(`Data: ${new Date().toLocaleString()}`);
    lines.push(`Limite per turno: ${m.limit}`);
    if(state.target != null) lines.push(`Punteggio obiettivo: ${state.target}`);
    lines.push("");

    const sorted = [...state.players].sort((a,b) => scoreOf(b) - scoreOf(a));
    sorted.forEach(p => {
      const s = scoreOf(p);
      const label = (s === bestScore) ? `  <-- VINCITORE (${ruleText})` : "";
      lines.push(`${p.name}: ${s} punti${label}`);
    });

    const exportData = {
      ...state,
      version: 4,
      exportedAt: new Date().toISOString(),
      summary: lines.join("\n")
    };

    const blob = new Blob([JSON.stringify(exportData, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    const dt = new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");
    a.href = URL.createObjectURL(blob);
    a.download = `segnapunti-${m.id}-${dt}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  function importGame(file){
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const data = JSON.parse(reader.result);
        if(!data || !Array.isArray(data.players) || !Array.isArray(data.rounds)) throw new Error("bad");

        state.mode = (data.mode === "3e7" || data.mode === "assemazz") ? data.mode : "assemazz";
        state.players = data.players.map(p => ({
          id: p.id || uid(),
          name: String(p.name || "Giocatore"),
          score: Number(p.score || 0)
        }));
        state.rounds = data.rounds.map(r => ({
          id: r.id || uid(),
          values: r.values || {},
          note: r.note || null,
          ts: r.ts || Date.now()
        }));
        state.target = (data.target == null) ? null : Number(data.target);

        save();
        renderModeUI();
        renderPlayers();
        renderScoreboard();
        renderTurnForm();
        renderHistory();
        checkWinner();
        if(state.target != null) $("#target").value = state.target;

        alert("Partita importata con successo.");
      } catch {
        alert("File non valido.");
      }
    };
    reader.readAsText(file);
  }

  function resetAll(){
    if(!confirm("Azzera tutto? Questa azione non √® reversibile.")) return;
    state.players = [];
    state.rounds = [];
    state.target = null;
    $("#target").value = "";
    save();
    renderPlayers();
    renderScoreboard();
    renderTurnForm();
    renderHistory();
    checkWinner();
  }

  function changeMode(newMode){
    if(newMode === state.mode) return;

    const ok = (state.rounds.length === 0 && state.players.every(p => scoreOf(p) === 0))
      ? true
      : confirm("Cambiare modalit√† resetta punteggi e turni (regole diverse). Vuoi continuare?");

    if(!ok){
      $("#mode-select").value = state.mode;
      return;
    }

    state.mode = newMode;
    state.players.forEach(p => p.score = 0);
    state.rounds = [];
    state.target = null;
    $("#target").value = "";
    $("#turn-note").value = "";

    save();
    renderModeUI();
    renderScoreboard();
    renderTurnForm();
    renderHistory();
    checkWinner();
  }

  // --- Events
  $("#add-player").addEventListener("click", () => {
    addPlayer($("#new-player").value);
    $("#new-player").value = "";
    $("#new-player").focus();
  });

  $("#new-player").addEventListener("keydown", e => {
    if(e.key === "Enter") $("#add-player").click();
  });

  $("#add-turn").addEventListener("click", addTurn);
  $("#undo-turn").addEventListener("click", undoTurn);
  $("#save-target").addEventListener("click", setTarget);
  $("#clear-target").addEventListener("click", clearTarget);
  $("#btn-export").addEventListener("click", exportGame);

  $("#import-file").addEventListener("change", e => {
    if(e.target.files && e.target.files[0]) importGame(e.target.files[0]);
    e.target.value = "";
  });

  $("#btn-reset").addEventListener("click", resetAll);

  $("#mode-select").addEventListener("change", e => changeMode(e.target.value));

  // --- Init
  renderModeUI();
  renderPlayers();
  renderScoreboard();
  renderTurnForm();
  renderHistory();
  checkWinner();
  if(state.target != null) $("#target").value = state.target;
</script>
</body>
</html>
